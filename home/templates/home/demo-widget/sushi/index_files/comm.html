
<!-- saved from url=(0066)https://rt.getsale.io/comm.html?v=ed6ed0c412ddcf315ab98c44877a3e2c -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript">
        
var Utils = {

    styles : [],

    extend : function () {
        var result = {};
        for (var i = 0, len = arguments.length; i < len; i++) {
            var obj = arguments[i];
            if (obj!=undefined) {
                for (var attrname in obj) {
                    if (obj.hasOwnProperty(attrname)) {
                        result[attrname] = obj[attrname];
                    }
                }
            }
        }
        return result;
    },

    on: function(action, listener) {
        Utils.onElement(window, action, listener);
    },

    off: function(action, listener) {
        Utils.offElement(window, action, listener);
    },

    onElement: function(element, action, listener) {
        if (element.addEventListener) {
            element.addEventListener(action, listener);
        } else {
            element.attachEvent('on' + action, listener);
        }
    },

    offElement: function(element, action, listener) {
        if (element.removeEventListener) {
            element.removeEventListener(action, listener);
        } else {
            element.detachEvent('on' + action, listener);
        }
    },


    withSingleInstance: function (key, callback) {
        if (!window[key]) {
            window[key] = 1;
            callback();
        }
    },

    generateIntargetLink : function(container){

        var links = {
            inTarget : 'https://intarget.ru?ref=c7e5a1a0601a272dae9346cb7bed40b',
            getSale : 'https://getsale.io?ref=c7e5a1a0601a272dae9346cb7bed40b'
        };

        var intargetLink = Utils.createElement('a','__Map(host -> rt.getsale.io)-link');
        intargetLink.href = links['Map(host -> rt.getsale.io)'];
        intargetLink.target = '_blank';

        if (container) {
            container.appendChild( intargetLink );
        }

        return intargetLink;


    },

    addStyle : function (str, id) {

        var elementId = "__int_stl_"+id;

        if ((this.styles.indexOf(id) == -1 || this.styles.indexOf(id) == undefined /*jquery.stylish-select.js fix*/) && !document.getElementById(elementId)) {
            this.styles.push(id);
            var el = document.createElement('style');
            el.type = "text/css";
            el.id = elementId;

            document.getElementsByTagName('head')[0].appendChild(el);

            if (el.styleSheet) {
                el.styleSheet.cssText= str;
                el.type = "text/css";
            } else {
                var i = document.createTextNode(str);
                el.appendChild(i);
            }
        }
    },
    createElement : function(elementName, className, parent) {
        var element = document.createElement(elementName);
        if (className) {
            element.className = className;
        }

        if (!!parent) {
            parent.appendChild(element);
        }
        return element;
    },


    parseMessageData: function(msg) {
        if (!msg || !msg.data) {
            return null;
        }

        if ((typeof msg.data === 'string') && (msg.data.substr(0, 1) === '{')) {
            var res = null;
            try {
                res = JSON.parse(msg.data)
            }
            catch (e) {
                res = null;
            }
            return res;
        }
        else {
            return msg.data;
        }
    },


    parseBoolean: function(obj) {
        if (typeof obj === "undefined") {
            return false;
        } else if (typeof obj === "boolean") {
            return obj;
        } else if (typeof obj === "string") {
            return obj === 'true';
        }
        else throw "Unsupported value: "+obj;
    },


    isFunction: function(functionToCheck) {
        var getType = {};
        return functionToCheck && getType.toString.call(functionToCheck) === '[object Function]';
    },

    isMobile : function() {

        var check = false;
        (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check = true})(navigator.userAgent||navigator.vendor||window.opera);
        return check;

    },

    createSupportElement: function(elementName) {
        var element = document.createElement(elementName);
        element.style.width = "1px";
        element.style.height = "1px";
        element.style.position = "absolute";
        element.style.top = "0";
        element.style.left = "-100px";
        element.style.margin = "0";
        element.style.border = "none";
        element.style.padding = "0";
        document.body.appendChild(element);
        return element;
    },

    getDocumentWidth : function(){
        return  Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
    },
    getDocumentHeight : function(){
        return  Math.max(document.documentElement.clientHeight, window.innerHeight, 0);
    },
    getWindowHeight : function(){
        return window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
        //return  Math.max(window.innerHeight, 0);
    },
    scrollTop : function(){
        return  Math.max(document.body.scrollTop, document.documentElement.scrollTop, 0);
    },

    hasClass : function(container, className) {
        return container.className.indexOf( className ) >= 0;
    },

    removeClass : function(container) {
        var classes = Array.prototype.slice.call(arguments, 1);
        classes.forEach(function(cssClass){
            container.className = container.className.replace(new RegExp(' ' + cssClass, 'g'), '').replace(new RegExp(cssClass, 'g'), '');
        });
    },

    addClass : function(container) {
        var classes = Array.prototype.slice.call(arguments, 1);
        classes.forEach(function(cssClass){
            container.className += ' '  + cssClass;
        });
    }





};

var noopFunction = function() {};
var EventType = {
    INIT : "init",
    WIDGET_SHOWN : "widget_shown",
    WIDGET_SUBMITTED : "widget_submitted",
    WIDGET_ACTION : "widget_action",
    WIDGET_CLOSED : "widget_closed",
    CONSULT_MESSAGE_RECEIVED : "consult_message_received",
    CONSULT_SETTINGS_FETCHED: 'consult_settings_fetched',
    CONSULT_SETTINGS_APPLIED: 'consult_settings_applied',
    CONSULT_READY : "consult_ready",
    CONSULT_VISIBLE : "consult_visible",
    CONSULT_MINIFIED : "consult_minified",
    CONSULT_EXPANDED : "consult_expanded",
};
var GetSaleEvent = function(eventType, params) {
    this.eventType = eventType;
    this.params = params;
};
;
function microAjax(B,A){this.bindFunction=function(E,D){return function(){return E.apply(D,[D])}};this.stateChange=function(D){if(this.request.readyState==4){this.callbackFunction(this.request.responseText)}};this.getRequest=function(){if(window.ActiveXObject){return new ActiveXObject("Microsoft.XMLHTTP")}else{if(window.XMLHttpRequest){return new XMLHttpRequest()}}return false};this.postBody=(arguments[2]||"");this.callbackFunction=A;this.url=B;this.request=this.getRequest();if(this.request){var C=this.request;C.onreadystatechange=this.bindFunction(this.stateChange,this);if(this.postBody!==""){C.open("POST",B,true);C.setRequestHeader("X-Requested-With","XMLHttpRequest");C.setRequestHeader("Content-type","application/x-www-form-urlencoded");C.setRequestHeader("Connection","close")}else{C.open("GET",B,true)}C.send(this.postBody)}};        !function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.qwest=e()}}(function(){var define,module,exports;return function e(t,n,o){function r(i,a){if(!n[i]){if(!t[i]){var p="function"==typeof require&&require;if(!a&&p)return p(i,!0);if(s)return s(i,!0);var u=new Error("Cannot find module '"+i+"'");throw u.code="MODULE_NOT_FOUND",u}var f=n[i]={exports:{}};t[i][0].call(f.exports,function(e){var n=t[i][1][e];return r(n?n:e)},f,f.exports,e,t,n,o)}return n[i].exports}for(var s="function"==typeof require&&require,i=0;i<o.length;i++)r(o[i]);return r}({1:[function(e,t,n){!function(e){"use strict";var n=function(e){var t=function(e,t,n){n="function"==typeof n?n():null===n?"":void 0===n?"":n,e[e.length]=encodeURIComponent(t)+"="+encodeURIComponent(n)},n=function(e,o,r){var s,i,a;if("[object Array]"===Object.prototype.toString.call(o))for(s=0,i=o.length;i>s;s++)n(e+"["+("object"==typeof o[s]?s:"")+"]",o[s],r);else if(o&&"[object Object]"===o.toString())for(a in o)o.hasOwnProperty(a)&&(e?n(e+"["+a+"]",o[a],r,t):n(a,o[a],r,t));else if(e)t(r,e,o);else for(a in o)t(r,a,o[a]);return r};return n("",e,[]).join("&").replace(/%20/g,"+")};"object"==typeof t&&"object"==typeof t.exports?t.exports=n:"function"==typeof define&&define.amd?define([],function(){return n}):e.param=n}(this)},{}],2:[function(e,t,n){!function(e){function t(e){return"function"==typeof e}function n(e){return"object"==typeof e}function o(e){"undefined"!=typeof setImmediate?setImmediate(e):"undefined"!=typeof process&&process.nextTick?process.nextTick(e):setTimeout(e,0)}var r;e[0][e[1]]=function s(e){var i,a=[],p=[],u=function(e,t){return null==i&&null!=e&&(i=e,a=t,p.length&&o(function(){for(var e=0;e<p.length;e++)p[e]()})),i};return u.then=function(u,f){var d=s(e),c=function(){function e(o){var s,i=0;try{if(o&&(n(o)||t(o))&&t(s=o.then)){if(o===d)throw new TypeError;s.call(o,function(){i++||e.apply(r,arguments)},function(e){i++||d(!1,[e])})}else d(!0,arguments)}catch(a){i++||d(!1,[a])}}try{var o=i?u:f;t(o)?e(o.apply(r,a||[])):d(i,a)}catch(s){d(!1,[s])}};return null!=i?o(c):p.push(c),d},e&&(u=e(u)),u}}("undefined"==typeof t?[window,"pinkySwear"]:[t,"exports"])},{}],qwest:[function(_dereq_,module,exports){module.exports=function(){var global=window||this,pinkyswear=_dereq_("pinkyswear"),jparam=_dereq_("jquery-param"),defaultOptions={},defaultXdrResponseType="json",defaultDataType="post",limit=null,requests=0,request_stack=[],getXHR=global.XMLHttpRequest?function(){return new global.XMLHttpRequest}:function(){return new ActiveXObject("Microsoft.XMLHTTP")},xhr2=""===getXHR().responseType,qwest=function(method,url,data,options,before){method=method.toUpperCase(),data=data||null,options=options||{};for(var name in defaultOptions)if(!(name in options))if("object"==typeof defaultOptions[name]&&"object"==typeof options[name])for(var name2 in defaultOptions[name])options[name][name2]=defaultOptions[name][name2];else options[name]=defaultOptions[name];var nativeResponseParsing=!1,crossOrigin,xhr,xdr=!1,timeoutInterval,aborted=!1,attempts=0,headers={},mimeTypes={text:"*/*",xml:"text/xml",json:"application/json",post:"application/x-www-form-urlencoded",document:"text/html"},accept={text:"*/*",xml:"application/xml; q=1.0, text/xml; q=0.8, */*; q=0.1",json:"application/json; q=1.0, text/*; q=0.8, */*; q=0.1"},i,j,serialized,response,sending=!1,delayed=!1,timeout_start,promise=pinkyswear(function(e){return e.abort=function(){xhr&&(xhr.abort(),--requests,aborted=!0)},e.send=function(){if(!sending){if(requests==limit)return void request_stack.push(e);if(++requests,sending=!0,timeout_start=(new Date).getTime(),xhr=getXHR(),crossOrigin&&("withCredentials"in xhr||!global.XDomainRequest||(xhr=new XDomainRequest,xdr=!0,"GET"!=method&&"POST"!=method&&(method="POST"))),xdr?xhr.open(method,url):(xhr.open(method,url,options.async,options.user,options.password),xhr2&&options.async&&(xhr.withCredentials=options.withCredentials)),!xdr)for(var t in headers)headers[t]&&xhr.setRequestHeader(t,headers[t]);if(xhr2&&"auto"!=options.responseType)try{xhr.responseType=options.responseType,nativeResponseParsing=xhr.responseType==options.responseType}catch(n){}xhr2||xdr?(xhr.onload=handleResponse,xhr.onerror=handleError):xhr.onreadystatechange=function(){4==xhr.readyState&&handleResponse()},"auto"!=options.responseType&&"overrideMimeType"in xhr&&xhr.overrideMimeType(mimeTypes[options.responseType]),before&&before(xhr),xdr?(xhr.onprogress=function(){},xhr.ontimeout=function(){},xhr.onerror=function(){},setTimeout(function(){xhr.send("GET"!=method?data:null)},0)):xhr.send("GET"!=method?data:null)}},e}),handleResponse=function(){var i,responseType;if(--requests,sending=!1,(new Date).getTime()-timeout_start>=options.timeout)return void(options.attempts&&++attempts==options.attempts?promise(!1,[new Error("Timeout ("+url+")"),xhr,response]):promise.send());request_stack.length&&request_stack.shift().send();try{if(nativeResponseParsing&&"response"in xhr&&null!==xhr.response)response=xhr.response;else{if(responseType=options.responseType,"auto"==responseType)if(xdr)responseType=defaultXdrResponseType;else{var ct=xhr.getResponseHeader("Content-Type")||"";responseType=ct.indexOf(mimeTypes.json)>-1?"json":ct.indexOf(mimeTypes.xml)>-1?"xml":"text"}switch(responseType){case"json":if(xhr.responseText.length)try{response="JSON"in global?JSON.parse(xhr.responseText):eval("("+xhr.responseText+")")}catch(e){throw"Error while parsing JSON body : "+e}break;case"xml":try{global.DOMParser?response=(new DOMParser).parseFromString(xhr.responseText,"text/xml"):(response=new ActiveXObject("Microsoft.XMLDOM"),response.async="false",response.loadXML(xhr.responseText))}catch(e){response=void 0}if(!response||!response.documentElement||response.getElementsByTagName("parsererror").length)throw"Invalid XML";break;default:response=xhr.responseText}}if("status"in xhr&&!/^2|1223/.test(xhr.status))throw xhr.status+" ("+xhr.statusText+")";promise(!0,[xhr,response])}catch(e){promise(!1,[e,xhr,response])}},handleError=function(e){--requests,promise(!1,[new Error("Connection aborted"),xhr,null])};if(options.async="async"in options?!!options.async:!0,options.cache="cache"in options?!!options.cache:!1,options.dataType="dataType"in options?options.dataType.toLowerCase():defaultDataType,options.responseType="responseType"in options?options.responseType.toLowerCase():"auto",options.user=options.user||"",options.password=options.password||"",options.withCredentials=!!options.withCredentials,options.timeout="timeout"in options?parseInt(options.timeout,10):3e4,options.attempts="attempts"in options?parseInt(options.attempts,10):1,i=url.match(/\/\/(.+?)\//),crossOrigin=i&&(i[1]?i[1]!=location.host:!1),"ArrayBuffer"in global&&data instanceof ArrayBuffer?options.dataType="arraybuffer":"Blob"in global&&data instanceof Blob?options.dataType="blob":"Document"in global&&data instanceof Document?options.dataType="document":"FormData"in global&&data instanceof FormData&&(options.dataType="formdata"),null!==data)switch(options.dataType){case"json":data=JSON.stringify(data);break;case"post":data=jparam(data)}if(options.headers){var format=function(e,t,n){return t+n.toUpperCase()};for(i in options.headers)headers[i.replace(/(^|-)([^-])/g,format)]=options.headers[i]}return"Content-Type"in headers||"GET"==method||options.dataType in mimeTypes&&mimeTypes[options.dataType]&&(headers["Content-Type"]=mimeTypes[options.dataType]),headers.Accept||(headers.Accept=options.responseType in accept?accept[options.responseType]:"*/*"),crossOrigin||"X-Requested-With"in headers||(headers["X-Requested-With"]="XMLHttpRequest"),options.cache||"Cache-Control"in headers||(headers["Cache-Control"]="no-cache"),"GET"==method&&data&&"string"==typeof data&&(url+=(/\?/.test(url)?"&":"?")+data),options.async&&promise.send(),promise},getNewPromise=function(e){var t=[],n=0,o=[];return pinkyswear(function(r){var s=-1,i=function(e){return function(i,a,p,u){var f=++s;return++n,t.push(qwest(e,r.base+i,a,p,u).then(function(e,t){o[f]=arguments,--n||r(!0,1==o.length?o[0]:[o])},function(){r(!1,arguments)})),r}};r.get=i("GET"),r.post=i("POST"),r.put=i("PUT"),r["delete"]=i("DELETE"),r["catch"]=function(e){return r.then(null,e)},r.map=function(e,t,n,o,r){return i(e.toUpperCase()).call(this,t,n,o,r)};for(var a in e)a in r||(r[a]=e[a]);return r.send=function(){for(var e=0,n=t.length;n>e;++e)t[e].send();return r},r.abort=function(){for(var e=0,n=t.length;n>e;++e)t[e].abort();return r},r})},q={base:"",get:function(){return getNewPromise(q).get.apply(this,arguments)},post:function(){return getNewPromise(q).post.apply(this,arguments)},put:function(){return getNewPromise(q).put.apply(this,arguments)},"delete":function(){return getNewPromise(q)["delete"].apply(this,arguments)},map:function(){return getNewPromise(q).map.apply(this,arguments)},xhr2:xhr2,limit:function(e){return limit=e,q},setDefaultOptions:function(e){return defaultOptions=e,q},setDefaultXdrResponseType:function(e){return defaultXdrResponseType=e.toLowerCase(),q},setDefaultDataType:function(e){return defaultDataType=e.toLowerCase(),q},getOpenRequests:function(){return requests}};return q}()},{"jquery-param":1,pinkyswear:2}]},{},[1,2])("qwest")});;
        var JSONP = function(global){
    // (C) WebReflection Essential - Mit Style
    // 216 bytes minified + gzipped via Google Closure Compiler
    function JSONP(uri, callback) {
        function JSONPResponse() {
            try { delete global[src] } catch(e) {
                // kinda forgot < IE9 existed
                // thanks @jdalton for the catch
                global[src] = null
            }
            documentElement.removeChild(script);
            callback.apply(this, arguments);
        }
        var src = prefix + id++, script = document.createElement("script");
        script.async = true;
        global[src] = JSONPResponse;
        documentElement.insertBefore(
            script,
            documentElement.lastChild
        ).src = uri + "=" + src;
    }
    var id = 0, prefix = "__intrgt_rslv_cb_", document = global.document, documentElement = document.documentElement;
    return JSONP;
}(this);
;
    </script>
</head>

<body>

<script>


    var host = "rt.getsale.io";

    function log(msg, arguments) {
        if (host.indexOf(".dev.") >= 0) {
            console.log("[CommunicationIframe] " + new Date().getTime() + " " + msg, arguments);
        }
    }


    function makeImpRequest(url, params, callback) {
        var img = document.createElement("img");
        var first = true;
        var impUrl = url;
        for (var p in params || {}) {
            if (params.hasOwnProperty(p)) {
                if (first) {
                    impUrl += "?";
                    first = false;
                }
                else {
                    impUrl += "&";
                }
                impUrl += p + "=" + encodeURIComponent(params[p]);
            }
        }
        img.src = impUrl;

        if (!!callback) {
            img.onload = callback;
            img.onerror = callback;
        }
        document.body.appendChild(img);
    }


    var syncCookie = function(params){
        JSONP('//' + (params.utlHost || host) + '/match/cke?rnd='+Math.random()+'&cb', function(cookie) {
            var request = qwest.get('//' + host + '/cookie?ck=' + cookie+'&rnd='+Math.random()+"&pid="+params["projectId"]);
            request.then(function(xhr, resolveResponse) {
                var res = resolveResponse;
                sendMessage({
                    param: 'cookie_synchronized',
                    resolveUser: res["resolve"]
                });
            });

        })
    };


    function checkUser(params) {
        var uri = '//' + host + '/check?rnd='+Math.random()+"&pid="+params["projectId"];
        microAjax(uri, function(checkedUser) {
            log("Checked user", checkedUser);
            sendMessage({
                param: 'checked_user',
                checkedUser: JSON.parse(checkedUser)
            });
        });
    }

    function sendWidgetPromo( sendWidgetPromo) {
        var request = qwest.post('//' + host + '/wupd?rnd='+Math.random(), sendWidgetPromo, {dataType: 'json'});
        request.then(function(xhr,checkedUser) {
            sendMessage({
                param: 'checked_user',
                checkedUser: checkedUser
            });
        });
    }

    function invokeImpression(params) {
        var url = '//' + host + '/imp?';
        for (var p in params || {}) {
            if (params.hasOwnProperty(p)) {
                url += p + "=" + encodeURIComponent(params[p]) + "&";
            }
        }
        var request = qwest.get(url);
        request.then(function(xhr, impressionResp) {
            sendMessage({
                param: 'impressed',
                impressionResp: impressionResp
            });
        });
    }

    function invokeTarget(params) {
        var url = '//' + host + '/target?';
        for (var p in params || {}) {
            if (params.hasOwnProperty(p)) {
                url += p + "=" + encodeURIComponent(params[p]) + "&";
            }
        }
        var request = qwest.get(url);
        request.then(function(xhr, eventResp) {
            sendMessage({
                param: 'event_done',
                eventResp: eventResp
            });
        });
    }


    function checkPhoneCallback(params) {
        var request = qwest.get('//' + host + '/callback?rnd='+Math.random()+"&pid="+params["projectId"]);
        request.then(function(xhr, checkedPhoneCallback) {
            sendMessage({
                param: 'checked_phone_callback',
                checkedPhoneCallback: checkedPhoneCallback
            });
        });
    }

    function checkConsult(params) {
        log("Checking consult", params);
        var uri = '//' + host + '/v2/consult/check?pid='+params["projectId"]+'&url='+encodeURIComponent(params["url"])+'&rnd='+Math.random();

        microAjax(uri, function(checkedConsult) {
            log("Checked consult", checkedConsult);
            sendMessage({
                param: 'checked_consult',
                checkedConsult: JSON.parse(checkedConsult)
            });
        });
    }

    function importProfile(projectId, url, profile) {
        var uri = '//' + host + '/v2/profile/import/'+projectId+'?&url='+encodeURIComponent(url);
        qwest.post(uri, profile, {dataType: 'json'});
    }

    function consultImp(params) {
        var request = qwest.get('//' + host + '/v2/consult/check?pid='+params["projectId"]+'&rnd='+Math.random());
        request.then(function(xhr, checkedConsult) {
            sendMessage({
                param: 'checked_consult',
                checkedConsult: checkedConsult
            });
        });
    }

    var resolvedProfile = null;
    function getProfile(params) {
        if (resolvedProfile) {
            sendMessage({
                param: 'resolved_profile',
                profile: resolvedProfile
            })
        }
        else {
            var url = '//' + host + '/getProfile.json?rnd='+Math.random();
            for (var paramName in params) {
                if (params.hasOwnProperty(paramName)) {
                    url += "&" + paramName + "=" + encodeURIComponent(params[paramName]);
                }
            }
            var request = qwest.get(url);
            request.then( function(xhr, profile) {
                resolvedProfile = profile;
                sendMessage({
                    param: 'resolved_profile',
                    profile: profile
                });
            });
        }

    }

    var resolvedUuid = null;
    function getUuid(params) {
        if (resolvedUuid) {
            sendMessage({
                param: 'resolved_uuid',
                uuid: resolvedUuid
            })
        }
        else {
            var url = '//' + host + '/getUuid.json?rnd='+Math.random();
            for (var paramName in params) {
                if (params.hasOwnProperty(paramName)) {
                    url += "&" + paramName + "=" + encodeURIComponent(params[paramName]);
                }
            }
            var request = qwest.get(url);
            request.then( function(xhr, uuid) {
                resolvedUuid = uuid;
                sendMessage({
                    param: 'resolved_uuid',
                    uuid: uuid
                });
            });
        }

    }


    function invokePut(url, data) {
        qwest.put(url, data);
    }

    var messageListener = function (e) {

        var message;
        if (typeof e.data === 'string') {
            try {
                message = JSON.parse(e.data);
            }
            catch (e) {
            }
        }
        else {
            message = e.data;
        }
        var action = message ? message.action || null : null;


        if (action) {
            switch (action) {
                case "wimp":
                case "wact":
                case "call_widget_click":
                case "resolve":
                case "match":
                case "privacy_choice":
                case "action_analyze":

                    makeImpRequest("//" + host + message.path, message.data);
                    break;
                case "wupd":
                    sendWidgetPromo( message.data);
                    break;
                case "checkUser":
                    checkUser(message.data);
                    break;
                case "checkPhoneCallback":
                    checkPhoneCallback(message.data);
                    break;
                case "importProfile":
                    importProfile(message.projectId, message.url, message.profile);
                    break;
                case "consultImp":
                case "consultExpand":
                    invokePut("//" + host + message.path, message.data);
                    break;
                case "checkConsult":
                    checkConsult(message.data);
                    break;
                case "imp":
                    invokeImpression(message.data);
                    break;
                case "target":
                    invokeTarget(message.data);
                    break;
                case "get_profile":
                    getProfile(message.data);
                    break;
                case "get_uuid":
                    getUuid(message.data);
                    break;
                case "sync":
                    syncCookie( message.data);
                    break;
                case "clean":
                    Utils.off("message", messageListener);
                    break;
                default:
                    break;
            }

        }
    };

    var sendMessage = function(message){
        log("Sending message", message);
        window.parent.postMessage(JSON.stringify(Utils.extend(message, {
            action: "notify"
        })), "*");
    };


    Utils.on("message", messageListener);
    sendMessage({param: 'initialized'});

</script>


</body></html>